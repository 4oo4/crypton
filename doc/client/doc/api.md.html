<!DOCTYPE html><html><head><title>api.md</title><meta http-equiv="content-type" content="text/html; charset=UTF-8"><link rel="stylesheet" media="all" href="../../doc-style.css"><script src="../../doc-filelist.js"></script><script>var relativeDir = '../../', thisFile = '/usr/local/share/npm/lib/node_modules/otis/res/tmpl.jade', defaultSidebar = true;</script><script src="../../doc-script.js"></script></head><body><div id="sidebar_wrapper"><div id="sidebar_switch"><span class="tree">Files</span><span class="headings">Headings</span></div><div id="tree"></div><div id="headings"><div class="heading h1"><a href="#client">Client</a></div><div class="heading h2"><a href="#global">Global</a></div><div class="heading h3"><a href="#crypton.host-and-crypton.port">crypton.host and crypton.port</a></div><div class="heading h3"><a href="#crypton.on-eventname--callback-">crypton.on(eventName, callback)</a></div><div class="heading h3"><a href="#crypton.generateacount-username--passphrase--callback-">crypton.generateAcount(username, passphrase, callback)</a></div><div class="heading h3"><a href="#crypton.authorize-username--passphrase--callback-">crypton.authorize(username, passphrase, callback)</a></div><div class="heading h3"><a href="#crypton.resurrect-sessionstring--callback-">crypton.resurrect(sessionString, callback)</a></div><div class="heading h2"><a href="#sessions">Sessions</a></div><div class="heading h3"><a href="#session.on-eventname--callback-">session.on(eventName, callback)</a></div><div class="heading h3"><a href="#session.off-eventname-">session.off(eventName)</a></div><div class="heading h3"><a href="#session.serialize-callback-">session.serialize(callback)</a></div><div class="heading h3"><a href="#session.ping-callback-">session.ping(callback)</a></div><div class="heading h3"><a href="#session.load-containername--callback-">session.load(containerName, callback)</a></div><div class="heading h3"><a href="#session.create-containername--callback-">session.create(containerName, callback)</a></div><div class="heading h2"><a href="#accounts">Accounts</a></div><div class="heading h3"><a href="#session.account">session.account</a></div><div class="heading h3"><a href="#session.account.save-callback-">session.account.save(callback)</a></div><div class="heading h3"><a href="#session.account.refresh-callback-">session.account.refresh(callback)</a></div><div class="heading h3"><a href="#session.account.version">session.account.version</a></div><div class="heading h2"><a href="#transactions">Transactions</a></div><div class="heading h3"><a href="#tx---session.transaction.create--">tx = session.transaction.create()</a></div><div class="heading h3"><a href="#tx.chunks">tx.chunks</a></div><div class="heading h3"><a href="#tx.save-container--object---container1--container2---...-">tx.save(container, object, [container1, container2], ...)</a></div><div class="heading h3"><a href="#tx.commit-callback-">tx.commit(callback)</a></div><div class="heading h2"><a href="#containers">Containers</a></div><div class="heading h3"><a href="#container.get-objectname--callback-">container.get(objectName, callback)</a></div><div class="heading h3"><a href="#container.save-callback-">container.save(callback)</a></div><div class="heading h3"><a href="#container.add-key--value-">container.add(key, value)</a></div><div class="heading h3"><a href="#container.version">container.version</a></div><div class="heading h3"><a href="#container.gethistory-callback-">container.getHistory(callback)</a></div><div class="heading h3"><a href="#container.getdiff-callback-">container.getDiff(callback)</a></div><div class="heading h2"><a href="#messages">Messages</a></div><div class="heading h3"><a href="#session.inbox.poll-callback-">session.inbox.poll(callback)</a></div><div class="heading h3"><a href="#session.inbox.list-callback-">session.inbox.list(callback)</a></div><div class="heading h3"><a href="#session.inbox.filter--">session.inbox.filter()</a></div><div class="heading h3"><a href="#session.inbox.get--">session.inbox.get()</a></div><div class="heading h3"><a href="#session.inbox.delete--">session.inbox.delete()</a></div><div class="heading h3"><a href="#session.inbox.clear--">session.inbox.clear()</a></div><div class="heading h3"><a href="#session.inbox.on--">session.inbox.on()</a></div><div class="heading h3"><a href="#message.headers">message.headers</a></div><div class="heading h3"><a href="#message.body">message.body</a></div><div class="heading h3"><a href="#message.delete--">message.delete()</a></div><div class="heading h2"><a href="#peers">Peers</a></div><div class="heading h3"><a href="#session.getpeer--">session.getPeer()</a></div><div class="heading h3"><a href="#peer.sendmessage--">peer.sendMessage()</a></div><div class="heading h3"><a href="#peer.share--">peer.share()</a></div><div class="heading h3"><a href="#peer.unshare--">peer.unshare()</a></div><div class="heading h1"><a href="#server">Server</a></div><div class="heading h2"><a href="#account">Account</a></div><div class="heading h3"><a href="#post--account">POST /account</a></div><div class="heading h3"><a href="#post--account--username">POST /account/:username</a></div><div class="heading h3"><a href="#post--account--username-password">POST /account/:username/password</a></div><div class="heading h2"><a href="#session">Session</a></div><div class="heading h3"><a href="#get--session">GET /session</a></div><div class="heading h2"><a href="#transaction">Transaction</a></div><div class="heading h3"><a href="#post--transaction">POST /transaction</a></div><div class="heading h3"><a href="#post--transaction--token-commit">POST /transaction/:token/commit</a></div><div class="heading h3"><a href="#delete--transaction--token">DELETE /transaction/:token</a></div><div class="heading h2"><a href="#container">Container</a></div><div class="heading h3"><a href="#get--container--container_name_ciphertext">GET /container/:container_name_ciphertext</a></div><div class="heading h3"><a href="#post--container--container_name_ciphertext">POST /container/:container_name_ciphertext</a></div><div class="heading h3"><a href="#get--container--container_name_ciphertext--record_version_identifier">GET /container/:container_name_ciphertext/:record_version_identifier</a></div><div class="heading h2"><a href="#messages">Messages</a></div><div class="heading h3"><a href="#get--inbox">GET /inbox</a></div><div class="heading h3"><a href="#get--inbox--message_identifier">GET /inbox/:message_identifier</a></div><div class="heading h3"><a href="#delete--inbox--message_identifier">DELETE /inbox/:message_identifier</a></div><div class="heading h3"><a href="#post--outbox">POST /outbox</a></div></div></div><div id="sidebar-toggle"></div><div id="container"><div class="docs markdown">
<div class="pilwrap" id="client">
  <h1>
    <a href="#client" class="pilcrow">&#182;</a>
    Client
  </h1>
</div>



<div class="pilwrap" id="global">
  <h2>
    <a href="#global" class="pilcrow">&#182;</a>
    Global
  </h2>
</div>



<div class="pilwrap" id="crypton.host-and-crypton.port">
  <h3>
    <a href="#crypton.host-and-crypton.port" class="pilcrow">&#182;</a>
    crypton.host and crypton.port
  </h3>
</div>


<p>Defaults to <code>localhost:2013</code>. You should override these before any other calls are made. Note that cross-domain requests may be enabled in the server configuration.</p>


<div class="pilwrap" id="crypton.on-eventname--callback-">
  <h3>
    <a href="#crypton.on-eventname--callback-" class="pilcrow">&#182;</a>
    crypton.on(eventName, callback)
  </h3>
</div>



<div class="pilwrap" id="crypton.generateacount-username--passphrase--callback-">
  <h3>
    <a href="#crypton.generateacount-username--passphrase--callback-" class="pilcrow">&#182;</a>
    crypton.generateAcount(username, passphrase, callback)
  </h3>
</div>


<p><em>crypto</em>  </p>


<div class="highlight"><pre><code><span class="n">algorithms</span><span class="o">:</span>
    <span class="n">AES256</span> <span class="n">CFB</span> <span class="n">and</span> <span class="mi">128</span> <span class="n">bit</span> <span class="n">segment</span> <span class="n">width</span> <span class="o">(</span><span class="mi">16</span> <span class="n">bytes</span><span class="o">)</span>
    <span class="n">RSA</span>
    <span class="n">KDF</span> <span class="o">(</span><span class="n">PBKDF2</span> <span class="n">w</span><span class="o">/</span> <span class="mi">50</span><span class="o">,</span><span class="mi">000</span> <span class="n">rounds</span><span class="o">)</span>

<span class="n">generate</span><span class="o">:</span> 
    <span class="mi">32</span> <span class="n">random</span> <span class="n">bytes</span> <span class="n">hmac</span> <span class="n">key</span> <span class="k">for</span> <span class="n">container</span> <span class="n">names</span> <span class="o">(</span><span class="s2">&quot;container_name_hmac_key&quot;</span><span class="o">)</span>
    <span class="mi">32</span> <span class="n">random</span> <span class="n">bytes</span> <span class="n">hmac</span> <span class="n">key</span> <span class="k">for</span> <span class="n">general</span> <span class="n">data</span> <span class="n">authentication</span> <span class="o">(</span><span class="s2">&quot;hmac_key&quot;</span><span class="o">)</span>
    <span class="mi">32</span> <span class="n">random</span> <span class="n">bytes</span> <span class="k">for</span> <span class="o">(</span><span class="s2">&quot;salt_key&quot;</span><span class="o">)</span>
    <span class="mi">32</span> <span class="n">random</span> <span class="n">bytes</span> <span class="k">for</span> <span class="o">(</span><span class="s2">&quot;salt_challenge&quot;</span><span class="o">)</span>
    <span class="mi">32</span> <span class="n">random</span> <span class="n">bytes</span> <span class="k">for</span> <span class="o">(</span><span class="s2">&quot;symkey&quot;</span><span class="o">)</span>
    <span class="n">rsa</span> <span class="n">keypair</span> <span class="o">(</span><span class="mi">2048</span> <span class="n">bits</span><span class="o">)</span> <span class="o">(</span><span class="n">rsa_keypair_obj</span><span class="o">)</span>

<span class="n">outputs</span><span class="o">:</span>
    <span class="n">challenge_key</span> <span class="o">=</span> <span class="n">kdf</span><span class="o">(</span><span class="n">salt_challenge</span><span class="o">,</span> <span class="n">passphrase</span><span class="o">)</span> 
    <span class="n">keypair_key</span> <span class="o">=</span> <span class="n">kdf</span><span class="o">(</span><span class="n">salt_key</span><span class="o">,</span> <span class="n">passphrase</span><span class="o">)</span> 
    <span class="n">keypair_as_string</span> <span class="o">=</span> <span class="n">rsa_keypair_obj</span><span class="o">.</span><span class="na">serialize_to_string</span><span class="o">()</span>
    <span class="n">pubkey_as_string</span> <span class="o">=</span> <span class="n">rsa_keypair_obj</span><span class="o">.</span><span class="na">public_key</span><span class="o">.</span><span class="na">serialize_to_string</span><span class="o">()</span>
    <span class="n">keypair_iv</span> <span class="o">=</span> <span class="n">sha256</span><span class="o">(</span><span class="n">uuid</span><span class="o">()).</span><span class="n">digest</span><span class="o">()[:</span><span class="mi">16</span><span class="o">]</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">aes256cfb</span><span class="o">(</span><span class="n">key</span><span class="o">=</span><span class="n">keypair_key</span><span class="o">,</span> <span class="n">iv</span><span class="o">=</span><span class="n">keypair_iv</span><span class="o">)</span>
    <span class="err">#</span> <span class="n">XXX</span> <span class="n">padding</span> <span class="o">(</span><span class="n">must</span> <span class="n">be</span> <span class="n">length</span> <span class="n">of</span> <span class="n">multiple</span> <span class="n">of</span> <span class="mi">16</span><span class="o">)</span>
    <span class="n">keypair_serialized_ciphertext</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="na">encrypt</span><span class="o">(</span><span class="n">keypair_as_string</span><span class="o">)</span> 
    <span class="n">symkey_ciphertext</span> <span class="o">=</span> <span class="n">rsa_keypair_obj</span><span class="o">.</span><span class="na">encrypt_to_private</span><span class="o">(</span><span class="n">symkey</span><span class="o">)</span>
    <span class="n">container_name_hmac_key_iv</span> <span class="o">=</span> <span class="n">sha256</span><span class="o">(</span><span class="n">uuid</span><span class="o">()).</span><span class="n">digest</span><span class="o">()[:</span><span class="mi">16</span><span class="o">]</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">aes256cfb</span><span class="o">(</span><span class="n">key</span><span class="o">=</span><span class="n">symkey</span><span class="o">,</span> <span class="n">iv</span><span class="o">=</span><span class="n">container_name_hmac_key_iv</span><span class="o">)</span>
    <span class="n">container_name_hmac_key_ciphertext</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="na">encrypt</span><span class="o">(</span><span class="n">container_name_hmac_key</span><span class="o">)</span>
    <span class="n">hmac_key_iv</span> <span class="o">=</span> <span class="n">sha256</span><span class="o">(</span><span class="n">uuid</span><span class="o">()).</span><span class="n">digest</span><span class="o">()[:</span><span class="mi">16</span><span class="o">]</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">aes256cfb</span><span class="o">(</span><span class="n">key</span><span class="o">=</span><span class="n">symkey</span><span class="o">,</span> <span class="n">iv</span><span class="o">=</span><span class="n">hmac_key_iv</span><span class="o">)</span>
    <span class="n">hmac_key_ciphertext</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="na">encrypt</span><span class="o">(</span><span class="n">hmac_key</span><span class="o">)</span>


<span class="n">steps</span><span class="o">:</span>
    <span class="n">save</span> <span class="k">this</span> <span class="n">object</span><span class="o">:</span>
        <span class="o">{</span>
            <span class="n">hmac_key</span><span class="o">:</span> <span class="mi">32</span> <span class="n">byte</span> <span class="n">string</span><span class="o">,</span> <span class="n">base64ed</span>
            <span class="n">salt_key</span><span class="o">:</span> <span class="mi">32</span> <span class="n">byte</span> <span class="n">string</span><span class="o">,</span> <span class="n">base64ed</span>
            <span class="n">salt_challenge</span><span class="o">:</span> <span class="mi">32</span> <span class="n">byte</span> <span class="n">string</span><span class="o">,</span> <span class="n">base64ed</span>
            <span class="n">keypair_iv</span><span class="o">:</span> <span class="mi">16</span> <span class="n">byte</span> <span class="n">string</span><span class="o">,</span> <span class="n">base64ed</span>
            <span class="n">keypair_serialized_ciphertext</span><span class="o">:</span> <span class="n">many</span> <span class="n">bytes</span><span class="o">,</span> <span class="n">base64ed</span>
            <span class="n">pubkey_serialized</span><span class="o">:</span> <span class="n">many</span> <span class="n">bytes</span><span class="o">,</span> <span class="n">base64ed</span>
            <span class="n">challenge_key</span><span class="o">:</span> <span class="mi">32</span> <span class="n">byte</span> <span class="n">string</span><span class="o">,</span> <span class="n">base64ed</span>
            <span class="n">symkey_ciphertext</span><span class="o">:</span> <span class="n">many</span> <span class="n">bytes</span><span class="o">,</span> <span class="n">base64ed</span>
            <span class="n">container_name_hmac_key_iv</span><span class="o">:</span> <span class="mi">16</span> <span class="n">byte</span> <span class="n">string</span><span class="o">,</span> <span class="n">base64ed</span>
            <span class="n">container_name_hmac_key_ciphertext</span><span class="o">:</span> <span class="mi">32</span> <span class="n">byte</span> <span class="n">string</span><span class="o">,</span> <span class="n">base64ed</span>
            <span class="n">hmac_key_iv</span><span class="o">:</span> <span class="mi">16</span> <span class="n">byte</span> <span class="n">string</span><span class="o">,</span> <span class="n">base64ed</span>
            <span class="n">hmac_key_ciphertext</span><span class="o">:</span> <span class="mi">32</span> <span class="n">byte</span> <span class="n">string</span><span class="o">,</span> <span class="n">base64ed</span>
        <span class="o">}</span>

<span class="n">discard</span><span class="o">:</span>
    <span class="n">keypair_key</span>
    <span class="n">rsa_keypair_obj</span>
    <span class="n">cipher</span> <span class="n">objects</span>
    <span class="n">symkey</span>
    <span class="n">container_name_hmac_key</span>
    <span class="n">hmac_key</span>
    <span class="n">keypair_as_string</span>
    <span class="n">pubkey_as_string</span>
</code></pre></div>



<p>Creates an account object and generates the appropriate salts and keys. </p>

<p>Checks with the server to validate the username, and calls back with a potentially empty <code>error</code> argument and a conditional <code>account</code> argument which must still be <code>save()</code>d.</p>


<div class="pilwrap" id="crypton.authorize-username--passphrase--callback-">
  <h3>
    <a href="#crypton.authorize-username--passphrase--callback-" class="pilcrow">&#182;</a>
    crypton.authorize(username, passphrase, callback)
  </h3>
</div>


<p><em>crypto</em></p>

<p>Step 1: get a challenge from the server.</p>


<div class="highlight"><pre><code><span class="n">The</span> <span class="n">server</span> <span class="n">constructs</span> <span class="n">a</span> <span class="n">challenge</span> <span class="n">like</span> <span class="n">this</span><span class="o">:</span>

<span class="cp"># make a challenge</span>
<span class="n">random_string</span> <span class="o">=</span> <span class="n">random</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">time_value</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="err">#</span> <span class="n">any</span> <span class="n">string</span> <span class="n">representing</span> <span class="n">a</span> <span class="n">timestamp</span> <span class="n">will</span> <span class="k">do</span>
<span class="n">challenge_key</span> <span class="o">=</span> <span class="n">challenge_key</span> <span class="n">from</span> <span class="n">account</span>
<span class="n">salt_challenge</span> <span class="o">=</span> <span class="n">salt_challenge</span> <span class="n">from</span> <span class="n">account</span>
<span class="n">aes_iv</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">uuid</span><span class="p">()).</span><span class="n">digest</span><span class="p">()[</span><span class="o">:</span><span class="mi">16</span><span class="p">]</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">aes256cfb</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">challenge_key</span><span class="p">,</span> <span class="n">iv</span><span class="o">=</span><span class="n">iv</span><span class="p">,</span> <span class="n">segment_width</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="n">challenge</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">random_string</span><span class="p">)</span>

<span class="cp"># compute the answer we antipate from the client </span>
<span class="n">answer_cipher</span> <span class="o">=</span> <span class="n">aes256cfb</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">challenge</span><span class="p">,</span> <span class="n">iv</span><span class="o">=</span><span class="n">iv</span><span class="p">,</span> <span class="n">segment_width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">time_value_ciphertext</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">time_value</span><span class="p">)</span>
<span class="n">expected_answer_digest</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">time_value_ciphertext</span><span class="p">).</span><span class="n">digest</span><span class="p">()</span>

<span class="n">Persist</span> <span class="n">the</span> <span class="n">challenge</span> <span class="n">to</span> <span class="n">the</span> <span class="n">database</span> <span class="n">in</span> <span class="n">the</span> <span class="n">challenge</span> <span class="n">table</span><span class="p">,</span> <span class="n">so</span> <span class="n">that</span> <span class="n">we</span>
<span class="n">can</span> <span class="n">check</span> <span class="n">the</span> <span class="n">challenge</span> <span class="n">response</span> <span class="n">when</span> <span class="n">it</span> <span class="n">comes</span> <span class="n">in</span><span class="p">.</span>  <span class="n">Get</span> <span class="n">the</span> <span class="n">challenge_id</span>
<span class="n">back</span> <span class="k">for</span> <span class="n">the</span> <span class="n">inserted</span> <span class="n">row</span><span class="p">.</span>

<span class="n">challenge_identifier</span> <span class="o">=</span> <span class="n">public_id</span><span class="p">(</span><span class="n">challenge_id</span><span class="p">)</span>

<span class="n">The</span> <span class="n">server</span> <span class="n">returns</span> <span class="n">this</span> <span class="n">as</span> <span class="n">the</span> <span class="n">challenge</span> <span class="n">response</span><span class="o">:</span>

<span class="p">{</span>
    <span class="nl">challenge_id:</span> <span class="n">challenge_identifier</span><span class="p">,</span>
    <span class="nl">challenge:</span> <span class="n">base64</span><span class="p">(</span><span class="n">challenge</span><span class="p">),</span>
    <span class="nl">salt_challenge:</span> <span class="n">base64</span><span class="p">(</span><span class="n">salt_challenge</span><span class="p">),</span>
    <span class="nl">iv:</span> <span class="n">base64</span><span class="p">(</span><span class="n">aes_iv</span><span class="p">),</span>
    <span class="nl">time_value:</span> <span class="n">time_value</span>
<span class="p">}</span>
</code></pre></div>



<p>Step 2: construct an answer to the challenge</p>


<div class="highlight"><pre><code><span class="n">The</span> <span class="n">way</span> <span class="n">this</span> <span class="n">works</span><span class="p">,</span> <span class="n">is</span> <span class="n">that</span> <span class="n">we</span> <span class="n">prove</span> <span class="n">that</span> <span class="n">given</span> <span class="n">the</span> <span class="n">salt_challenge</span><span class="p">,</span> <span class="n">we</span> <span class="n">can</span>
<span class="n">calculate</span> <span class="n">challenge_key</span> <span class="p">(</span><span class="n">using</span> <span class="n">our</span> <span class="n">passphrase</span><span class="p">)</span> <span class="n">and</span> <span class="n">then</span> <span class="n">make</span> <span class="n">use</span> <span class="n">of</span> <span class="n">it</span> <span class="n">to</span>
<span class="n">encrypt</span> <span class="n">an</span> <span class="n">answer</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">server</span><span class="p">.</span>

<span class="n">In</span> <span class="n">this</span> <span class="k">case</span><span class="p">,</span> <span class="n">we</span><span class="err">&#39;</span><span class="n">re</span> <span class="n">deriving</span> <span class="n">the</span> <span class="n">key</span><span class="p">,</span> <span class="n">and</span> <span class="n">then</span> <span class="n">encrypting</span> <span class="n">time_value</span> <span class="n">using</span>
<span class="n">that</span> <span class="n">key</span><span class="p">,</span> <span class="n">and</span> <span class="n">sending</span> <span class="n">the</span> <span class="n">ciphtertext</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">server</span><span class="p">.</span>

<span class="n">challenge_key</span> <span class="o">=</span> <span class="n">kdf</span><span class="p">(</span><span class="n">salt_challenge</span><span class="p">,</span> <span class="n">passphrase</span><span class="p">)</span> 
<span class="n">cipher</span> <span class="o">=</span> <span class="n">aes256cfb</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">challenge_key</span><span class="p">,</span> <span class="n">iv</span><span class="o">=</span><span class="n">iv</span><span class="p">,</span> <span class="n">segment_width</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="n">challenge</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">challenge</span><span class="p">)</span>

<span class="n">cipher</span> <span class="o">=</span> <span class="n">aes256cfb</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">challenge</span><span class="p">,</span> <span class="n">iv</span><span class="o">=</span><span class="n">iv</span><span class="p">,</span> <span class="n">segment_width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">time_value_ciphertext</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">time_value</span><span class="p">)</span>

<span class="n">Post</span> <span class="n">an</span> <span class="n">answer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">challenge</span> <span class="n">like</span> <span class="n">this</span><span class="o">:</span>

<span class="p">{</span>
    <span class="nl">challenge_id:</span> <span class="n">challenge_id</span><span class="p">,</span>
    <span class="nl">answer:</span> <span class="n">base64</span><span class="p">(</span><span class="n">time_value_ciphertext</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div>



<p>If we have sucessfully answered the challenge, the server should then respond
  with our account info and a session token.</p>

<p><em>end_crypto</em></p>

<p>Performs the necessary handshakes with the server, and calls back with a potentiall empty <code>error</code> object and a conditional <code>session</code> argument.</p>


<div class="pilwrap" id="crypton.resurrect-sessionstring--callback-">
  <h3>
    <a href="#crypton.resurrect-sessionstring--callback-" class="pilcrow">&#182;</a>
    crypton.resurrect(sessionString, callback)
  </h3>
</div>


<p>Reconstructs a serialized session and pings the server to check its validity.</p>


<div class="pilwrap" id="sessions">
  <h2>
    <a href="#sessions" class="pilcrow">&#182;</a>
    Sessions
  </h2>
</div>



<div class="pilwrap" id="session.on-eventname--callback-">
  <h3>
    <a href="#session.on-eventname--callback-" class="pilcrow">&#182;</a>
    session.on(eventName, callback)
  </h3>
</div>


<p>Session objects are event emitters. <code>on()</code></p>


<div class="pilwrap" id="session.off-eventname-">
  <h3>
    <a href="#session.off-eventname-" class="pilcrow">&#182;</a>
    session.off(eventName)
  </h3>
</div>


<p>Removes all event listeners for a given <code>eventName</code>.</p>


<div class="pilwrap" id="session.serialize-callback-">
  <h3>
    <a href="#session.serialize-callback-" class="pilcrow">&#182;</a>
    session.serialize(callback)
  </h3>
</div>


<p>Stringifies said session object for later use, and calls back with a potentially empty <code>error</code> argument and a conditional <code>session</code> string argument.</p>


<div class="pilwrap" id="session.ping-callback-">
  <h3>
    <a href="#session.ping-callback-" class="pilcrow">&#182;</a>
    session.ping(callback)
  </h3>
</div>


<p>Hits the appropriate route on the server to check for the validity of said session. Calls back with a potentially empty <code>error</code> argument. If the argument is empty, the session is still valid.</p>


<div class="pilwrap" id="session.load-containername--callback-">
  <h3>
    <a href="#session.load-containername--callback-" class="pilcrow">&#182;</a>
    session.load(containerName, callback)
  </h3>
</div>


<p><em>crypto</em>
_end_crypto</p>

<p>Checks for a cached <code>container</code> that is available to said session. If the <code>container</code> is not cached or a more current version is available, the latest version is retreived from the server and cached.</p>


<div class="pilwrap" id="session.create-containername--callback-">
  <h3>
    <a href="#session.create-containername--callback-" class="pilcrow">&#182;</a>
    session.create(containerName, callback)
  </h3>
</div>


<p><em>crypto</em></p>

<p>Attempts to create a container, checking with the server to see if the namespace is available for the current session. Calls back with a potentially empty <code>error</code> argument.</p>

<p>Container names are encrypted and their plaintext is unknown to the server.</p>


<div class="pilwrap" id="accounts">
  <h2>
    <a href="#accounts" class="pilcrow">&#182;</a>
    Accounts
  </h2>
</div>



<div class="pilwrap" id="session.account">
  <h3>
    <a href="#session.account" class="pilcrow">&#182;</a>
    session.account
  </h3>
</div>


<p>An object containing a representation of the account associated with said session.</p>

<p>Example structure:</p>


<div class="highlight"><pre><code><span class="p">{</span>
  <span class="nx">username</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="nx">passphrase</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="nx">keys</span><span class="o">:</span> <span class="p">{</span> <span class="p">},</span>
  <span class="nx">save</span><span class="o">:</span> <span class="nb">Function</span><span class="p">,</span>
  <span class="nx">refresh</span><span class="o">:</span> <span class="nb">Function</span><span class="p">,</span>
  <span class="nx">version</span><span class="o">:</span> <span class="nb">Function</span>
<span class="p">}</span>
</code></pre></div>




<div class="pilwrap" id="session.account.save-callback-">
  <h3>
    <a href="#session.account.save-callback-" class="pilcrow">&#182;</a>
    session.account.save(callback)
  </h3>
</div>


<p><em>crypto</em>
<em>diff</em></p>

<p>Determines the differences between the previous version of the account of said session and saves it with the server. Calls back with a potentially empty <code>error</code> argument.</p>


<div class="pilwrap" id="session.account.refresh-callback-">
  <h3>
    <a href="#session.account.refresh-callback-" class="pilcrow">&#182;</a>
    session.account.refresh(callback)
  </h3>
</div>


<p><em>crypto?</em></p>

<p>Checks with the server for new account versions from other devices. Calls back with a potentially empty <code>error</code> argument. If the argument is empty, the account has been updated.</p>


<div class="pilwrap" id="session.account.version">
  <h3>
    <a href="#session.account.version" class="pilcrow">&#182;</a>
    session.account.version
  </h3>
</div>


<p>Holds the current version hash of the session.</p>


<div class="pilwrap" id="transactions">
  <h2>
    <a href="#transactions" class="pilcrow">&#182;</a>
    Transactions
  </h2>
</div>


<p>Transactions are how all data is moved to the server. All <code>save()</code> methods transparently construct a transaction and commit it. </p>


<div class="pilwrap" id="tx---session.transaction.create--">
  <h3>
    <a href="#tx---session.transaction.create--" class="pilcrow">&#182;</a>
    tx = session.transaction.create()
  </h3>
</div>



<div class="pilwrap" id="tx.chunks">
  <h3>
    <a href="#tx.chunks" class="pilcrow">&#182;</a>
    tx.chunks
  </h3>
</div>


<p>An array holding the <code>save()</code>d chunks of the transaction.</p>


<div class="pilwrap" id="tx.save-container--object---container1--container2---...-">
  <h3>
    <a href="#tx.save-container--object---container1--container2---...-" class="pilcrow">&#182;</a>
    tx.save(container, object, [container1, container2], ...)
  </h3>
</div>


<p>Adds a chunk of data to the server. Accepts an abitrary amount of arguments containing containers and/or their objects in any format.</p>


<div class="pilwrap" id="tx.commit-callback-">
  <h3>
    <a href="#tx.commit-callback-" class="pilcrow">&#182;</a>
    tx.commit(callback)
  </h3>
</div>


<p><em>crypto</em>
<em>diff</em></p>

<p>Finalizes the transaction, determines differences in containers, encrypts the data, and sends it to the server. Calls back with a potentially empty <code>error</code> argument. If the argument is empty, the transaction has been committed.</p>


<div class="pilwrap" id="containers">
  <h2>
    <a href="#containers" class="pilcrow">&#182;</a>
    Containers
  </h2>
</div>



<div class="pilwrap" id="container.get-objectname--callback-">
  <h3>
    <a href="#container.get-objectname--callback-" class="pilcrow">&#182;</a>
    container.get(objectName, callback)
  </h3>
</div>


<p><em>crypto</em>
<em>undiff</em></p>


<div class="pilwrap" id="container.save-callback-">
  <h3>
    <a href="#container.save-callback-" class="pilcrow">&#182;</a>
    container.save(callback)
  </h3>
</div>


<p><em>crypto</em>
<em>diff</em></p>

<p>Determines the differences with the previously saved version of the container. Calls back with a potentially empty <code>error</code> argument. If the argument is empty, the container has been committed to the server.</p>


<div class="pilwrap" id="container.add-key--value-">
  <h3>
    <a href="#container.add-key--value-" class="pilcrow">&#182;</a>
    container.add(key, value)
  </h3>
</div>


<p>Adds a magic key to said container.</p>


<div class="pilwrap" id="container.version">
  <h3>
    <a href="#container.version" class="pilcrow">&#182;</a>
    container.version
  </h3>
</div>


<p>Holds the current version hash of the container.</p>


<div class="pilwrap" id="container.gethistory-callback-">
  <h3>
    <a href="#container.gethistory-callback-" class="pilcrow">&#182;</a>
    container.getHistory(callback)
  </h3>
</div>


<p>Hits the server for a list of known version identifiers. Calls back with a potentially empty <code>error</code> argument and conditionally a <code>history</code> argument containing an array of version identifiers.</p>


<div class="pilwrap" id="container.getdiff-callback-">
  <h3>
    <a href="#container.getdiff-callback-" class="pilcrow">&#182;</a>
    container.getDiff(callback)
  </h3>
</div>


<p>Constructs a Diff object containing the changes with the last known version of the container. Calls back with a potentially empty <code>error</code> argument, and conditionally a <code>diff</code> argument.</p>


<div class="pilwrap" id="messages">
  <h2>
    <a href="#messages" class="pilcrow">&#182;</a>
    Messages
  </h2>
</div>



<div class="pilwrap" id="session.inbox.poll-callback-">
  <h3>
    <a href="#session.inbox.poll-callback-" class="pilcrow">&#182;</a>
    session.inbox.poll(callback)
  </h3>
</div>



<div class="pilwrap" id="session.inbox.list-callback-">
  <h3>
    <a href="#session.inbox.list-callback-" class="pilcrow">&#182;</a>
    session.inbox.list(callback)
  </h3>
</div>



<div class="pilwrap" id="session.inbox.filter--">
  <h3>
    <a href="#session.inbox.filter--" class="pilcrow">&#182;</a>
    session.inbox.filter()
  </h3>
</div>



<div class="pilwrap" id="session.inbox.get--">
  <h3>
    <a href="#session.inbox.get--" class="pilcrow">&#182;</a>
    session.inbox.get()
  </h3>
</div>



<div class="pilwrap" id="session.inbox.delete--">
  <h3>
    <a href="#session.inbox.delete--" class="pilcrow">&#182;</a>
    session.inbox.delete()
  </h3>
</div>



<div class="pilwrap" id="session.inbox.clear--">
  <h3>
    <a href="#session.inbox.clear--" class="pilcrow">&#182;</a>
    session.inbox.clear()
  </h3>
</div>



<div class="pilwrap" id="session.inbox.on--">
  <h3>
    <a href="#session.inbox.on--" class="pilcrow">&#182;</a>
    session.inbox.on()
  </h3>
</div>



<div class="pilwrap" id="message.headers">
  <h3>
    <a href="#message.headers" class="pilcrow">&#182;</a>
    message.headers
  </h3>
</div>



<div class="pilwrap" id="message.body">
  <h3>
    <a href="#message.body" class="pilcrow">&#182;</a>
    message.body
  </h3>
</div>



<div class="pilwrap" id="message.delete--">
  <h3>
    <a href="#message.delete--" class="pilcrow">&#182;</a>
    message.delete()
  </h3>
</div>



<div class="pilwrap" id="peers">
  <h2>
    <a href="#peers" class="pilcrow">&#182;</a>
    Peers
  </h2>
</div>



<div class="pilwrap" id="session.getpeer--">
  <h3>
    <a href="#session.getpeer--" class="pilcrow">&#182;</a>
    session.getPeer()
  </h3>
</div>



<div class="pilwrap" id="peer.sendmessage--">
  <h3>
    <a href="#peer.sendmessage--" class="pilcrow">&#182;</a>
    peer.sendMessage()
  </h3>
</div>


<div class='highlight'><pre><code language=''>function uuid_factory() {
    // build a function that generates sequential uuids that are difficult to
    // cause collisions, but don't require constant streoam of new entropy
    private_counter = 1
    initial_timestamp = timestamp
    initial_random = random(32)
    function uuid2() {
        private_counter += 1
        uuid = sha256(initial_random + initial_timestamp + private_counter).hexdigest()
        return uuid
    }
    return uuid2
}

// give us a uuid closure
uuid = uuid_factory()

// this is memoizable based on peer name or maybe peer private key id
function session_key_ciphertext_for_peer(peer) {
    session_key = random(32)
    hmac_key = random(32)
    session_key_ciphertext = peer.publickey.encrypt(session_key)
    hmac_key_ciphertext = peer.publickey.encrypt(hmac_key)
    return {session_key, session_key_ciphertext, hmac_key_ciphertext}
}

session_key_ciphertext = session_key_ciphertext_for_peer(peer)
# how to send the first message...
headers_iv = sha256(uuid()).digest()[:16]
body_iv = sha256(uuid()).digest()[:16]

headers = {}
headers_plaintext = zlib.compress(json.stringify(headers))
headers_cipher = aes256cfb(key=session_key, iv=headers_iv)
headers_ciphertext =  headers_cipher.encrypt(headers_plaintext)

body = {}
body_plaintext = zlib.compress(json.stringify(body))
body_cipher =  aes256cfb(key=session_key, iv=body_iv)
body_ciphertext = body_cipher.encrypt(body_plaintext)

message_signature_hash = sha256(headers_ciphertext + headers_plaintext).digest()
message_signature = account.private_key.sign(message_signature_hash)

post this:
{
    peer_name: ...
    session_key_ciphertext:
    headers_iv:
    body_iv:
    headers_ciphertext:
    body_ciphertext:
    message_signature:
}
</code></pre></div>


<div class="pilwrap" id="peer.share--">
  <h3>
    <a href="#peer.share--" class="pilcrow">&#182;</a>
    peer.share()
  </h3>
</div>



<div class="pilwrap" id="peer.unshare--">
  <h3>
    <a href="#peer.unshare--" class="pilcrow">&#182;</a>
    peer.unshare()
  </h3>
</div>



<div class="pilwrap" id="server">
  <h1>
    <a href="#server" class="pilcrow">&#182;</a>
    Server
  </h1>
</div>


<p>The server is a simple REST server running on node. The default all bodies are sent and received with JSON. The default success response is:</p>


<div class="highlight"><pre><code><span class="p">{</span>
  <span class="nx">success</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div>




<div class="pilwrap" id="account">
  <h2>
    <a href="#account" class="pilcrow">&#182;</a>
    Account
  </h2>
</div>



<div class="pilwrap" id="post--account">
  <h3>
    <a href="#post--account" class="pilcrow">&#182;</a>
    POST /account
  </h3>
</div>


<p>Creates a new account with client-generated data.</p>

<p>Required body:</p>


<div class="highlight"><pre><code><span class="p">{</span>

<span class="p">}</span>
</code></pre></div>



<p>Sets session_identifier cookie (logs you in immediately) upon successful request.</p>


<div class="pilwrap" id="post--account--username">
  <h3>
    <a href="#post--account--username" class="pilcrow">&#182;</a>
    POST /account/:username
  </h3>
</div>


<p>Logs into account and sets <code>session_identifier</code> cookie.</p>

<p>Required body:</p>


<div class="highlight"><pre><code><span class="p">{</span>

<span class="p">}</span>
</code></pre></div>




<div class="pilwrap" id="post--account--username-password">
  <h3>
    <a href="#post--account--username-password" class="pilcrow">&#182;</a>
    POST /account/:username/password
  </h3>
</div>


<p>Changes the password for an account.</p>

<p>Required body:</p>


<div class="highlight"><pre><code><span class="p">{</span>
  <span class="nx">password</span><span class="o">:</span> <span class="nb">String</span>
<span class="p">}</span>
</code></pre></div>




<div class="pilwrap" id="session">
  <h2>
    <a href="#session" class="pilcrow">&#182;</a>
    Session
  </h2>
</div>



<div class="pilwrap" id="get--session">
  <h3>
    <a href="#get--session" class="pilcrow">&#182;</a>
    GET /session
  </h3>
</div>


<p>Pings the server to verify that the session is still valid. Must send <code>session_identifier</code> cookie.</p>

<p>If the session is invalid when an authentication-requiring route is requested, the default response will be:</p>


<div class="highlight"><pre><code><span class="p">{</span>
  <span class="nx">success</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Not logged in&quot;</span>
<span class="p">}</span>
</code></pre></div>




<div class="pilwrap" id="transaction">
  <h2>
    <a href="#transaction" class="pilcrow">&#182;</a>
    Transaction
  </h2>
</div>



<div class="pilwrap" id="post--transaction">
  <h3>
    <a href="#post--transaction" class="pilcrow">&#182;</a>
    POST /transaction
  </h3>
</div>


<p>Generates and sets <code>transaction_token</code> cookie.</p>

<p>Requires <code>session_identifier</code> cookie.</p>


<div class="pilwrap" id="post--transaction--token-commit">
  <h3>
    <a href="#post--transaction--token-commit" class="pilcrow">&#182;</a>
    POST /transaction/:token/commit
  </h3>
</div>


<p>Commit (finalize) the transaction.</p>

<p>Requires <code>session_identifier</code> cookie.</p>

<p>May return the following:</p>


<div class="highlight"><pre><code><span class="p">{</span>
  <span class="nx">success</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Transaction token invalid&quot;</span>
<span class="p">}</span>
</code></pre></div>




<div class="pilwrap" id="delete--transaction--token">
  <h3>
    <a href="#delete--transaction--token" class="pilcrow">&#182;</a>
    DELETE /transaction/:token
  </h3>
</div>


<p>Cancel a transaction without committing it to the server.</p>

<p>Requires <code>session_identifier</code> cookie.</p>

<p>May return the following:</p>


<div class="highlight"><pre><code><span class="p">{</span>
  <span class="nx">success</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Transaction token invalid&quot;</span>
<span class="p">}</span>
</code></pre></div>




<div class="pilwrap" id="container">
  <h2>
    <a href="#container" class="pilcrow">&#182;</a>
    Container
  </h2>
</div>



<div class="pilwrap" id="get--container--container_name_ciphertext">
  <h3>
    <a href="#get--container--container_name_ciphertext" class="pilcrow">&#182;</a>
    GET /container/:container_name_ciphertext
  </h3>
</div>


<p>Returns all headers of the records in the container.</p>

<p>Requires <code>session_identifier</code> cookie.</p>

<p>Optional parameter <code>?after=record_version_identifier</code> will only return the headers for records occuring after said <code>record_version_identifier</code></p>

<p>Example:</p>


<div class="highlight"><pre><code><span class="p">{</span>

<span class="p">}</span>
</code></pre></div>




<div class="pilwrap" id="post--container--container_name_ciphertext">
  <h3>
    <a href="#post--container--container_name_ciphertext" class="pilcrow">&#182;</a>
    POST /container/:container_name_ciphertext
  </h3>
</div>


<p><code>multipart/form-upload</code> of json + payload for this modification
// TODO fail early if the transaction is borked</p>

<p>Requires <code>session_identifier</code> cookie.</p>

<p>A valid transaction token is required or the route will return the following:</p>


<div class="highlight"><pre><code><span class="p">{</span>
  <span class="nx">success</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Transaction token invalid&quot;</span>
<span class="p">}</span>
</code></pre></div>




<div class="pilwrap" id="get--container--container_name_ciphertext--record_version_identifier">
  <h3>
    <a href="#get--container--container_name_ciphertext--record_version_identifier" class="pilcrow">&#182;</a>
    GET /container/:container_name_ciphertext/:record_version_identifier
  </h3>
</div>


<p>Returns binary data of the ciphertext from the given <code>record_version_identifier</code> of the enciphered <code>container_name</code>.</p>

<p>Requires <code>session_identifier</code> cookie.</p>


<div class="pilwrap" id="messages">
  <h2>
    <a href="#messages" class="pilcrow">&#182;</a>
    Messages
  </h2>
</div>



<div class="pilwrap" id="get--inbox">
  <h3>
    <a href="#get--inbox" class="pilcrow">&#182;</a>
    GET /inbox
  </h3>
</div>


<p>Returns list of message headers as JSON objects.</p>

<p>Requires <code>session_identifier</code> cookie.</p>

<p>Optional parameters of <code>from=username</code> and <code>since=timestamp</code> may be used to filter.</p>

<p>Example response:</p>


<div class="highlight"><pre><code><span class="p">{</span>

<span class="p">}</span>
</code></pre></div>




<div class="pilwrap" id="get--inbox--message_identifier">
  <h3>
    <a href="#get--inbox--message_identifier" class="pilcrow">&#182;</a>
    GET /inbox/:message_identifier
  </h3>
</div>


<p>Returns headers and ciphtertext of payload of message with matching <code>message_identifier</code></p>

<p>Requires <code>session_identifier</code> cookie.</p>

<p>Example response:</p>


<div class="highlight"><pre><code><span class="p">{</span>

<span class="p">}</span>
</code></pre></div>




<div class="pilwrap" id="delete--inbox--message_identifier">
  <h3>
    <a href="#delete--inbox--message_identifier" class="pilcrow">&#182;</a>
    DELETE /inbox/:message_identifier
  </h3>
</div>


<p>Deletes a given message by <code>message_identifier</code></p>

<p>Requires <code>session_identifier</code> cookie.</p>

<p>May return the following:</p>


<div class="highlight"><pre><code><span class="p">{</span>
  <span class="nx">success</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Transaction token invalid&quot;</span>
<span class="p">}</span>
</code></pre></div>




<div class="pilwrap" id="post--outbox">
  <h3>
    <a href="#post--outbox" class="pilcrow">&#182;</a>
    POST /outbox
  </h3>
</div>


<p>Send a message by <code>multipart/form-upload</code> of json + payload
// TODO fail early if the transaction is borked</p>

<p>Requires <code>session_identifier</code> cookie.</p>

<p>Example post data:</p>


<div class="highlight"><pre><code><span class="c1">// TODO decide on format</span>
</code></pre></div>



<p>Requires session_identifier cookie.</p>

<p>May return the following:</p>


<div class="highlight"><pre><code><span class="p">{</span>
  <span class="nx">success</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">error</span><span class="o">:</span> <span class="s2">&quot;Transaction token invalid&quot;</span>
<span class="p">}</span>
</code></pre></div>

</div></div></body></html>